#!/bin/bash
# postinst script for astroberry-manager

set -e

if [ "$1" == "configure" ]; then

	if [ ! -e /opt/astroberry-manager ]; then
		mkdir -p /opt/astroberry-manager
	fi

	# deploy in python virtual environment
	python -m venv /opt/astroberry-manager/.venv && \
	/opt/astroberry-manager/.venv/bin/pip install --upgrade /tmp/astroberry_manager-*-py3-none-any.whl

	# clean up
	if [ $? -eq 0 ]; then rm -rf /tmp/astroberry_manager-*-py3-none-any.whl; fi

	# enable required services
	ln -s /usr/lib/systemd/system/vncserver.service /etc/systemd/system/multi-user.target.wants/
	ln -s /usr/lib/systemd/system/websockify.service /etc/systemd/system/multi-user.target.wants/
	ln -s /usr/lib/systemd/system/indiwebmanager.service /etc/systemd/system/multi-user.target.wants/
	ln -s /usr/lib/systemd/system/astroberry-manager.service /etc/systemd/system/multi-user.target.wants/

	# add config for reverse proxy
	if [ -e /etc/caddy/Caddyfile ] && [ ! -e /etc/caddy/Caddyfile.default ]; then cp /etc/caddy/Caddyfile /etc/caddy/Caddyfile.default; fi
	cat <<EOF > /etc/caddy/Caddyfile
{
        auto_https disable_redirects
}

http://astroberry.local {
        handle /api* {
            reverse_proxy localhost:8624
        }
        handle /websockify* {
            reverse_proxy localhost:8070
        }
        handle /* {
            reverse_proxy localhost:8080
        }
}

https://astroberry.local {
        handle /api* {
            reverse_proxy localhost:8624
        }
        handle /websockify* {
            reverse_proxy localhost:8070
        }
        handle /* {
            reverse_proxy localhost:8080
        }
}
EOF

fi
